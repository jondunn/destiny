<!DOCTYPE html>

<style>
table.usergrid {
  border: 0;
}

table.usergrid td {
  vertical-align: top;
}

table.usergrid img {
  float: left;
  height: 4em;
  width: 4em;
}
</style>

<h2>
  {% if user.account_type == 1 %}
    <img src="https://www.bungie.net/img/theme/destiny/icons/icon_xbl.png" style="height: 1em">
  {% elif user.account_type == 2 %}
    <img src="https://www.bungie.net/img/theme/destiny/icons/icon_psn.png" style="height: 1em">
  {% endif %}
  <a href="https://www.bungie.net/en/Profile/{{user.account_type}}/{{user.account_id}}">{{user.name}}</a>
  {% if user.clan %}of {{user.clan}}{% endif %}
</h2>

Glimmer: {{user.currency.glimmer}}<br>

<table class="usergrid">
{% for characterid, character in user.characters|dictsort %}
  {% macro inventory(name) %}
    {% if character.inventory[name] %}
      {% set item = character.inventory[name] %}
      <td title="{{item.desc|e}}">
        <img src="https://www.bungie.net{{item.icon}}">
        {{item.name}}
        {% if item.perks %}
          <div style="font-size: .7em">
            <div>Perks:</div>
            {% for perk in item.perks %}
              <div title="{{perk.desc|e}}">&mdash; {{perk.name}}</div>
            {% endfor %}
          </div>
        {% endif %}
      </td>
    {% else %}
      <td>(No {{name}} item.)</td>
    {% endif %}
  {% endmacro %}

  <tr>
    <td colspan="5"><h3 style="background: url(https://www.bungie.net{{character.emblem_banner}}) no-repeat 4em; height: 4em">
      <img src="https://www.bungie.net{{character.emblem_icon}}">
      <a href="https://www.bungie.net/en/Legend/{{user.account_type}}/{{user.account_id}}/{{characterid}}" style="color: white">Level {{character.level}} {{character.race}} {{character.gender}} {{character.class}}</a><br>
      <span style="color: yellow">Last online: <script>document.write(new Date({{character.last_online}} * 1000).toLocaleString());</script></span><br>
    </h3></td>
  </tr><tr>
    {{inventory('subclass')}}
    {{inventory('helmet')}}
    {{inventory('class_armor')}}
    {{inventory('ships')}}
    <td rowspan="4"><table>
      {% if character.current_activity %}
        <tr>
          <td>
            {% if character.current_activity.name.startswith(character.current_activity.type) %}
              {{character.current_activity.name}}
            {% else %}
              {{character.current_activity.type}}: {{character.current_activity.name}}
            {% endif %}
          </td>
          <td></td>
          <td></td>
          <td>active</td>
        </tr>
      {% endif %}
      {% for activity in character.activities %}
        <tr>
          <td>
            {% if activity.name.startswith(activity.type) %}
              {{activity.name}}
            {% else %}
              {{activity.type}}: {{activity.name}}
            {% endif %}
          </td>
          <td>{% if activity.score %}{{activity.score}} points{% endif %}</td>
          <td>{{activity.duration}} seconds</td>
          <td>{{activity.completed and 'completed' or 'abandoned'}}</td>
        </tr>
      {% endfor %}
    </table></td>
    <td rowspan="4"><table>
      {% for name, progress in character.progress|dictsort %}
        <tr>
          <td>{{name}}</td>
          <td>{{progress.level}}</td>
          <td>{{progress.current}}/{{progress.next}} to {{progress.level + 1}}</td>
          <td>{{progress.daily}} today</td>
          <td>{{progress.weekly}} this week</td>
        </tr>
      {% endfor %}
    </table></td>
  </tr><tr>
    {{inventory('primary_weapons')}}
    {{inventory('gauntlets')}}
    {{inventory('ghost')}}
    {{inventory('shaders')}}
  </tr><tr>
    {{inventory('special_weapons')}}
    {{inventory('chest_armor')}}
    {{inventory('vehicle')}}
    {{inventory('emblems')}}
  </tr><tr>
    {{inventory('heavy_weapons')}}
    {{inventory('leg_armor')}}
    <td><table>
      <tr><td>Level</td><td>{{character.level}} ({{(100 * character.level_progress).__int__()}}% to {{character.level + 1}})</td></tr>
      <tr><td>Defense</td><td>{{character.stats.Defense}}</td></tr>
      <tr><td>Intellect</td><td>{{character.stats.Intellect}}</td></tr>
      <tr><td>Discipline</td><td>{{character.stats.Discipline}}</td></tr>
      <tr><td>Strength</td><td>{{character.stats.Strength}}</td></tr>
    </table></td>
    <td><table>
      <tr><td>Light</td><td>{{character.stats.Light}}</td></tr>
      <tr><td>Optics</td><td>{{character.stats.Optics}}</td></tr>
      <tr><td>Armor</td><td>{{character.stats.Armor}}</td></tr>
      <tr><td>Recovery</td><td>{{character.stats.Recovery}}</td></tr>
      <tr><td>Agility</td><td>{{character.stats.Agility}}</td></tr>
    </table></td>
  </tr>
{% endfor %}
</table>
