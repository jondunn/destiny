{% extends "_base.html" %}
{% block content %}

<style>
div.emblem {
  background-color: #212121;
  background-repeat: no-repeat;
  background-size: cover;
  color: white;
  float: left;
  height: 96px;
  overflow: hidden;
  position: relative;
  white-space: nowrap;
  width: 300px;
}

div.emblem > * {
  position: absolute;
}

div.emblem > img {
  left: 0px;
  top: 0px;
}

div.emblem > div.class {
  font-size: 40px;
  height: 57px;
  left: 96px;
  top: 0px;
}

div.emblem > div.subtitle {
  bottom: 0px;
  font-size: 20px;
  height: 39px;
  left: 96px;
}

div.emblem > div.level {
  font-size: 40px;
  height: 57px;
  right: 10px;
  top: 0px;
}

div.emblem > div.light {
  bottom: 0px;
  color: yellow;
  font-size: 20px;
  height: 39px;
  right: 10px;
}

a.item {
  background-color: #212121;
  color: white;
  float: left;
  height: 40px;
  overflow: hidden;
  position: relative;
  white-space: nowrap;
  width: 200px;
}

a.item > * {
  position: absolute;
}

a.item > img {
  height: 40px;
  left: 0px;
  top: 0px;
  width: 40px;
}

a.item > div.quantity {
  background-color: white;
  bottom: 0px;
  color: black;
  font-size: 8px;
  left: 0;
  padding: 2px;
}

a.item > div.title {
  font-size: 14px;
  left: 40px;
  top: 0px;
}

a.item > div.subtitle {
  bottom: 10px;
  font-size: 10px;
  left: 40px;
}

a.item > div.stat {
  background-color: #212121;
  font-size: 14px;
  padding-left: 4px;
  padding-right: 10px;
  right: 0px;
  top: 0px;
}

a.item > div.stat-type {
  background-color: #212121;
  bottom: 10px;
  font-size: 10px;
  padding-left: 4px;
  padding-right: 10px;
  right: 0px;
}
</style>

<script>
var user = new nmlorg.destiny.User('{{username|e}}');
var div = document.createElement('div');
document.body.appendChild(div);
div.textContent = 'Loading...';

user.get(function() {
  document.title = user.name + ' \u2022 Destiny Dashboard';
  div.textContent = '';
  var table = document.createElement('table');
  div.appendChild(table);
  table.className = 'table';
  var thead = document.createElement('thead');
  table.appendChild(thead);
  var tr = document.createElement('tr');
  thead.appendChild(tr);
  var td = document.createElement('td');
  tr.appendChild(td);
  td = document.createElement('td');
  tr.appendChild(td);
  td.colSpan = user.characters.length + 1;
  td.innerHTML += '<h1><img src="' + user.account_type_icon + '">' + user.name + '</h1>';
  tr = document.createElement('tr');
  thead.appendChild(tr);
  td = document.createElement('td');
  tr.appendChild(td);
  for (var i = 0; i < user.characters.length; i++) {
    var character = user.characters[i];
    td = document.createElement('td');
    tr.appendChild(td);
    td.appendChild(nmlorg.ui.banner(character));
  }
  td = document.createElement('td');
  tr.appendChild(td);
  td.innerHTML = '<div class="emblem"><div class="class">Vault</div></div>';

  var bucketNames = [];
  for (var i = 0; i < user.characters.length; i++)
    for (var bucket in user.characters[i].inventory)
      if (bucketNames.indexOf(bucket) == -1)
        bucketNames.push(bucket);
  for (var bucket in user.vault)
    if (bucketNames.indexOf(bucket) == -1)
      bucketNames.push(bucket);
  bucketNames.sort()

  var tbody = document.createElement('tbody');
  table.appendChild(tbody);
  for (var i = 0; i < bucketNames.length; i++) {
    var bucketName = bucketNames[i];
    var buckets = [];
    for (var j = 0; j < user.characters.length; j++)
      buckets.push(user.characters[j].inventory[bucketName] || []);
    buckets.push(user.vault[bucketName] || []);

    var tr = document.createElement('tr');
    tbody.appendChild(tr);
    var td = document.createElement('td');
    tr.appendChild(td);
    td.textContent = bucketName;
    for (var j = 0; j < buckets.length; j++) {
      var bucket = buckets[j];
      var items = [];
      for (var k = 0; k < bucket.length; k++) {
        var item = bucket[k];
        items.push([1 / (item.primary_stat_value || 1), item.name, item]);
      }
      items.sort();
      td = document.createElement('td');
      tr.appendChild(td);
      if (items.length == 1)
        td.appendChild(nmlorg.ui.item(items[0][2]));
      else if (items.length > 1) {
        var itemDiv = document.createElement('div');
        td.appendChild(itemDiv);
        itemDiv.style.display = 'none';
        for (var k = 0; k < items.length; k++)
          itemDiv.appendChild(nmlorg.ui.item(items[k][2]));
        var br = document.createElement('br');
        itemDiv.appendChild(br);
        br.style.clear = 'both';
        var toggleDiv = document.createElement('div');
        td.appendChild(toggleDiv);
        toggleDiv.textContent = '+ ' + items.length + ' ' + bucketName;
        if (toggleDiv.textContent[toggleDiv.textContent.length - 1] != 's')
          toggleDiv.textContent += 's';
        toggleDiv.addEventListener('click', function() {
          var itemDiv = this.previousElementSibling;
          if (itemDiv.style.display == '') {
            itemDiv.style.display = 'none';
            this.textContent = '+' + this.textContent.substr(1);
          } else {
            itemDiv.style.display = '';
            this.textContent = '-' + this.textContent.substr(1);
          }
        });
        toggleDiv.style.cursor = 'pointer';
      }
    }
  }
});
</script>

{% endblock %}
