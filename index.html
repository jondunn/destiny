<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Orbitron:700">
<link rel="stylesheet" href="/site.css">
<script src="destiny.js"></script>
<script src="store.js"></script>

<title>Destiny Dashboard</title>

<body>

<h1 style="white-space: nowrap">Desti<img alt="n" src="/favicon.ico" style="width: .75em">y Dashboard</h1>

<script>
var placeDivs = {};
var userDivs = {};
var userTimeouts = {};

function moveCharacter(character) {
  var now = Date.now() / 1000;
  var activity;

  if (now - character['last_online'] > 600)
    activity = '~Offline';
  else if (!character['current_activity'])
    activity = '~In Orbit';
  else if (character['current_activity']['name'].match('^' + character['current_activity']['type']))
    activity = character['current_activity']['name'];
  else
    activity = character['current_activity']['type'] + ': ' + character['current_activity']['name'];

  console.log('User', character.name, 'is in', activity);

  if (userDivs[character.name.toLowerCase()]) {
    var userDiv = userDivs[character.name.toLowerCase()];
    var oldPlaceDiv = userDiv.parentNode;

    oldPlaceDiv.removeChild(userDiv);

    if ((oldPlaceDiv.parentNode.dataset.activity != activity) &&
        (oldPlaceDiv.getElementsByTagName('div').length == 0)) {
      delete placeDivs[oldPlaceDiv.parentNode.dataset.activity];
      oldPlaceDiv.parentNode.parentNode.removeChild(oldPlaceDiv.parentNode);
    }
  }

  var userDiv = character.makeBanner('<img src="{{user.account_type_icon}}" style="height: 1em"> <a href="/user/{{name}}" style="color: white">{{name}}</a><br>{{title}}<br>');

  userDiv.style.position = 'relative';
  userDiv.dataset.name = character.name.toLowerCase();
  userDiv.dataset.last_online = 1 / character.last_online;
  userDivs[userDiv.dataset.name] = userDiv;
  addTo(userDiv, activity);

  var closeDiv = document.createElement('div');

  closeDiv.style.position = 'absolute';
  closeDiv.style.right = '5px';
  closeDiv.style.top = '0px';
  closeDiv.style.color = 'white';
  closeDiv.style.cursor = 'pointer';
  userDiv.appendChild(closeDiv);
  closeDiv.textContent = 'x';

  closeDiv.onclick = function(e) {
    var placeDiv = userDiv.parentNode;

    clearTimeout(userTimeouts[userDiv.dataset.name]);
    delete userTimeouts[userDiv.dataset.name];
    placeDiv.removeChild(userDiv);

    if (placeDiv.getElementsByTagName('div').length == 0) {
      delete placeDivs[placeDiv.parentNode.dataset.activity];
      placeDiv.parentNode.parentNode.removeChild(placeDiv.parentNode);
    }

    var i = store.users.indexOf(userDiv.dataset.name);

    store.users.splice(i, 1);
    store.users = store.users;
  };
}

function insertSorted(parent, elt, fieldName) {
  parent.appendChild(elt);

  for (var i = 0; i < parent.children.length; i++)
    if (elt.dataset[fieldName] < parent.children[i].dataset[fieldName]) {
      parent.removeChild(elt);
      parent.insertBefore(elt, parent.children[i]);
      break;
    }
}

var placeDivContainer = document.createElement('div');

document.body.appendChild(placeDivContainer);

function addTo(userDiv, activity) {
  var placeDiv = placeDivs[activity];

  if (!placeDiv) {
    var parentDiv = document.createElement('div');
    var titleDiv = document.createElement('div');
    var br = document.createElement('br');

    parentDiv.className = 'panel panel-info';
    parentDiv.dataset.activity = activity;
    insertSorted(placeDivContainer, parentDiv, 'activity');

    titleDiv.className = 'panel-heading';
    titleDiv.textContent = activity.replace(/^~/, '');
    parentDiv.appendChild(titleDiv);

    placeDiv = placeDivs[activity] = document.createElement('div');
    parentDiv.appendChild(placeDiv);

    br.style.clear = 'both';
    parentDiv.appendChild(br);
  }

  if (activity == '~Offline')
    insertSorted(placeDiv, userDiv, 'last_online');
  else
    insertSorted(placeDiv, userDiv, 'name');
}

function onGetUser(user) {
  moveCharacter(user.getActive());
  userTimeouts[user.name.toLowerCase()] = setTimeout(function() {
    user.get(onGetUser.bind(null, user));
  }, 15 * 1000 + Math.random() * 30 * 1000);
}

function addUser(userName) {
  var user = new nmlorg.destiny.User(userName);
  var userDiv = document.createElement('div');

  userDiv.className = 'banner';
  userDiv.textContent = user.name;
  userDiv.dataset.name = user.name.toLowerCase();
  userDivs[userDiv.dataset.name] = userDiv;
  addTo(userDiv, '~Loading');

  user.get(onGetUser.bind(null, user));
};

var store = new nmlorg.store.Store('nmlorg.destiny');

store.add('users', []);

for (var i = 0; i < store.users.length; i++)
  addUser(store.users[i]);

var addUserInput = document.createElement('input');

document.body.appendChild(addUserInput);
addUserInput.className = 'form-control';
addUserInput.placeholder = 'Type a PSN id or XBL tag to begin watching them.';
addUserInput.onchange = function(e) {
  addUser(addUserInput.value);
  store.users = store.users.concat(addUserInput.value.toLowerCase()).sort();
  addUserInput.value = '';
};
</script>
