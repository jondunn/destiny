<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Orbitron:700">
<link rel="stylesheet" href="/site.css">
<script src="destiny.js"></script>

<title>Destiny Dashboard</title>

<body>

<h1 style="white-space: nowrap">Desti<img alt="n" src="/favicon.ico" style="width: .75em">y Dashboard</h1>

<div id="users"></div>

<script>
var placeDivContainer = document.getElementById('users');
var placeDivs = {};
var userDivs = {};

function moveCharacter(character) {
  var now = Date.now() / 1000;
  var activity;

  if (now - character['last_online'] > 600)
    activity = '~Offline';
  else if (!character['current_activity'])
    activity = '~In Orbit';
  else if (character['current_activity']['name'].match('^' + character['current_activity']['type']))
    activity = character['current_activity']['name'];
  else
    activity = character['current_activity']['type'] + ': ' + character['current_activity']['name'];

  console.log('User', character.name, 'is in', activity);

  if (userDivs[character.name.toLowerCase()]) {
    var userDiv = userDivs[character.name.toLowerCase()];
    var oldPlaceDiv = userDiv.parentNode;

    oldPlaceDiv.removeChild(userDiv);

    if ((oldPlaceDiv.dataset.activity != activity) &&
        (oldPlaceDiv.getElementsByTagName('div').length == 0)) {
      delete placeDivs[oldPlaceDiv.dataset.activity];
      oldPlaceDiv.parentNode.removeChild(oldPlaceDiv);
    }
  }

  var userDiv = character.makeBanner('<img src="{{user.account_type_icon}}" style="height: 1em"> <a href="/user/{{name}}" style="color: white">{{name}}</a><br>{{level}} {{race}} {{gender}} {{class}}<br>');

  userDiv.dataset.name = character.name.toLowerCase();
  userDivs[userDiv.dataset.name] = userDiv;
  addTo(userDiv, activity);
}

function insertSorted(parent, elt, fieldName) {
  parent.appendChild(elt);

  for (var i = 0; i < parent.children.length; i++)
    if (elt.dataset[fieldName] < parent.children[i].dataset[fieldName]) {
      parent.removeChild(elt);
      parent.insertBefore(elt, parent.children[i]);
      break;
    }
}

function addTo(userDiv, activity) {
  var placeDiv = placeDivs[activity];

  if (!placeDiv) {
    placeDiv = placeDivs[activity] = document.createElement('div');
    placeDiv.innerHTML = '<br clear="all"><h3>' + activity + '</h3>';
    placeDiv.dataset.activity = activity;
    insertSorted(placeDivContainer, placeDiv, 'activity');
  }

  insertSorted(placeDiv, userDiv, 'name');
}

function onGetUser(user) {
  moveCharacter(user.getActive());
  setTimeout(function() {
    user.get(onGetUser.bind(null, user));
  }, 15 * 1000 + Math.random() * 30 * 1000);
}

var users = ['megakles1221', 'nmlorg', 'rybo3282', 'talut', 'mrsuperbloop', 'geekbeef'];

for (var i = 0; i < users.length; i++) {
  var user = new nmlorg.destiny.User(users[i]);
  var userDiv = document.createElement('div');

  userDiv.className = 'banner';
  userDiv.textContent = user.name;
  userDiv.dataset.name = user.name.toLowerCase();
  userDivs[userDiv.dataset.name] = userDiv;
  addTo(userDiv, '~Loading');

  user.get(onGetUser.bind(null, user));
}
</script>
